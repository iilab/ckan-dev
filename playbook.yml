---
- hosts: all
  tasks:
  - name: add the wheezy-backports repository
    apt_repository: repo='deb http://http.debian.net/debian wheezy-backports main' state=present
    sudo: yes

  - name: Install Kernel-3.14
    apt: pkg=linux-image-amd64 state=present default_release=wheezy-backports update_cache=true
    register: updated_kernel
    sudo: yes

  - name: Restart the server after partition update  
    command: "shutdown -r now"
    when: updated_kernel.changed
    sudo: true

  - name: Wait for server to come up after partition update  
    local_action: wait_for host={{ansible_ssh_host}} port={{ansible_ssh_port}} delay=30
    when: updated_kernel.changed
    sudo: false

  - name: Docker | Install apt dependencies for ansible apt
    apt:
      pkg: "{{ item }}"
      state: latest
    with_items:
      - python-apt
      - apt-transport-https

  - name: Docker | Add docker.io apt key
    apt_key:
      keyserver: 'keyserver.ubuntu.com'
      id: A88D21E9
      state: present

  - name: Docker | Add docker.io ubuntu apt repository
    apt_repository:
      repo: 'deb https://get.docker.io/ubuntu docker main'
      state: present

  - name: Docker | Make sure docker and its dependencies are installed
    apt:
      pkg: "{{ item }}"
      state: present
    with_items:
      - lxc-docker

  - name: Clone docker-py repository
    git: repo=https://github.com/docker/docker-py.git dest=/opt/docker-py
    sudo: yes

  - name: Install python-setuptools
    apt: pkg=python-setuptools state=present
    sudo: yes

  - name: install docker-py
    command: python setup.py install chdir=/opt/docker-py creates=/usr/local/lib/python2.7/dist-packages/docker_py-0.6.1_dev-py2.7.egg
    sudo: yes

# From http://docs.ckan.org/en/latest/maintaining/installing/install-using-docker.html#installing-ckan
# docker run -d --name db ckan/postgresql
# docker run -d --name solr ckan/solr
# docker run -d -p 80:80 --link db:db --link solr:solr ckan/ckan

  - name: Run postgresql image
    docker: image="ckan/postgresql" name="db" state=running
    sudo: yes

  - name: Run postgresql image
    docker: image="ckan/solr" name="solr" state=running
    sudo: yes

  - name: Run postgresql image
    docker: image="ckan/ckan" name="ckan" ports="80:80" links=['db:db','solr:solr'] state=running
    sudo: true